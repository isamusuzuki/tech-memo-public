# モノレポでの型共有

作成日 2025/09/29

## 1. 解説記事を読む

[モノレポでの型共有戦略](https://note.com/happy_avocet7237/n/nbd5f10ed1858)

### モノレポでは、以下の問題が発生しやすくなる

1. 型定義が各パッケージで分散している
2. 型の変更がどこに影響するか不透明
3. 型の共有でパッケージが循環参照になる

### 型共有の4原則

1. 型は共有パッケージで定義する
2. 全パッケージはその型に依存する
3. 型パッケージは一方向依存にする
4. 型の破壊的変更はCIで検知する

### フォルダ構成例

```text
root/
    |--apps/
    |   |--frontend/
    |   |--backend/
    |   `--cli/
    `--shared/
        |--types/  ... 全ての型を集中管理する（他に依存しない）
        |--utils/  ... 共通ユーティリティは別パッケージにする
        `--constants/ ... 定数も別パッケージにする
```

### ファイル設定例

shared/types/package.json

```json
{
  "name": "@shared/types",
  "version": "1.0.0",
  "main": "dist/index.js",
  "types": "dist/index.d.ts"
}
```

tsconfig.json（パスエイリアス設定を統一する）

```json
{
  "compilerOptions": {
    "paths": {
      "@shared/types": ["../shared/types/src/index.ts"]
    }
  }
}
```

shared/types/src/user.ts

```javascript
export type User = {
    id: string;
    name: string;
    email: string;
};
```

apps/frontend/src/hooks/useUser.ts

```javascript
import type { User } from '@shared/types';

const fetchUser = async (): Promise<User> => { ... };
```

apps/backend/src/controllers/user.ts

```javascript
import type { User } from '@shared/types';

export const getUser = (): User => { ... };
```

### 型の整合性をCIで担保する

```bash
npx tsd
```

tsdコマンドを各アプリのtestフェーズに組み込む

[tsd - npm](https://www.npmjs.com/package/tsd)

### Circular Dependency対策

- typesは他に依存しない単一方向パッケージにする
- 共通ユーティリティや定数は別パッケージに切り出す

### 型共有とGraphQL/RESTの関係

- RESTの場合 => OpenAPI Generator or Zodeでサーバー・クライアント間の型を統一
- GraphQLの場合 => graphql-codegenでSchemaから型を生成し、`@shared/types`に配置する
