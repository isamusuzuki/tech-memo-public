# 公式サンプルを試す

作成日 2025/12/25

[mhalbritter/spring-boot-and-opentelemetry: Showcase of Spring Boot using OpenTelemetry](https://github.com/mhalbritter/spring-boot-and-opentelemetry)

## 1. 開発コンテナを用意する

必要条件

- java 25
- Gradle 9.2.1
- docker-in-docker (DIND)

```json
{
    "name": "Docker in Docker",
    "image": "mcr.microsoft.com/devcontainers/base:bookworm",
    "features": {
        "ghcr.io/devcontainers/features/docker-in-docker:2": {
            "version": "latest",
            "enableNonRootDocker": "true",
            "moby": "true"
        },
        "ghcr.io/devcontainers/features/java:1": {
            "version": "25",
            "installGradle": "true",
            "gradleVersion": "latest"
        }
    },
   "customizations": {
        "vscode": {
            "extensions": [
                "vscjava.vscode-java-pack",
                "vmware.vscode-boot-dev-pack"
            ]
        }
    }
}
```

### 開発コンテナの中身を確認する

```bash
cat /etc/os-release
# PRETTY_NAME="Debian GNU/Linux 12 (bookworm)"

java --version
# openjdk 25.0.1 2025-10-21 LTS

gradle -v
# Gradle 9.2.1

docker --version
# Docker version 29.1.3-1

docker-compose --version
# Docker Compose version v2.40.3

echo $JAVA_HOME
# /usr/local/sdkman/candidates/java/current
echo $GRADLE_HOME
# /usr/local/sdkman/candidates/gradle/current

# SDKMAN!の使い方
sdk version
sdk list {java/maven/gradle}
sdk current {java/maven/gradle}
sdk install {java/maven/gradle} {Identifier}
# このコンテナでは、なぜか25.0.1-msから変更できなかった
```

## 2. 設定ファイル

```text
--spring-boot-and-opentelemetry/
    |--.sdkmanrc         ... SDKMANへの指示 java=25.0.1-librca
    |--compose.yaml      ... docker-composeの設定
    |--gradle.properties ... gradleで使う変数 springBootVersion=4.0.0
    |--settings.gradle   ... 3つのserviceとsharedをインクルードする
    `--{service,shared}/
        `--build.gradle  ... ビルド設計書
```

compose.yaml

```yaml
services:
    grafana-lgtm:
        image: 'grafana/otel-lgtm:latest'
        ports:
            - '3000:3000' # UI
            - '4317:4317'
            - '4318:4318'
```

## 3. デバッグ開始

### Docker in Dockerの立ち上げ

- ターミナルで`docker-compose up -d` （dはデタッチの意味）
- VSCodeのポートを確認したら3000が自動転送されていた
- ブラウザで`http://localhost:3000/`を開いたらGrafanaが登場した

### アプリケーションの立ち上げ

- VSCodeのデバッグで、launch.jsonを生成させる
- アプリケーションを選んで、順番に実行させる
- gradle.propertiesの変数の値を変更してはいけない。ビルドエラーが出てハマった

- GreetingServiceApplication => `http://localhost:8082/api`
- HelloServiceApplication => `http://localhost:8080/api/1`
- UserServiceApplication => `http://localhost:8081/api`
