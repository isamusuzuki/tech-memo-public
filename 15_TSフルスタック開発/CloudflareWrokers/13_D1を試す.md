# D1を試す

作成日 2025/09/10、更新日 2025/09/27

## 1. 解説動画を写経する

[【Cloudflare Workers】HonoとCloudflare D1を使って20分でREST APIを作成する](https://www.youtube.com/watch?v=XyjACmtXqj0)

公式ガイド（英語）も参照した

- [Getting started · Cloudflare D1 docs](https://developers.cloudflare.com/d1/get-started/)
- [Query D1 from Hono](https://developers.cloudflare.com/d1/examples/d1-and-hono/)

## 2. 新規プロジェクトを作成する

```bash
npm create cloudflare@latest
# dir ./simple-todo-api
# category Hello World example
# type Worker only
# lang TypeScript
# no git
# no deploy via 'npm run deploy'

cd simple-todo-api
npm run dev #=> Open browser to http://localhost:8787/
```

## 3. データベースを作成する

```bash
npx wrangler d1 create todoapi
```

- 開発コンテナを使っていると、ブラウザからのOAuthトークンの受け渡しがうまくいかない
- 代わりに、APIトークンを使用する
- ダッシュボード ＞ アカウントの管理 ＞ アカウントAPIトークン ＞ トークンを作成する ＞ D1編集の権限を追加したトークンを作成する
- .envファイルに、`CLOUDFLARE_API_TOKEN=xxx`を書き込む
- ダッシュボード ＞ アカウントホーム ＞ アカウント名の右横にある縦3個ドットをクリック ＞ アカウントIDをコピー
- wrangler.jsoncファイルに、`"account_id": "xxx"`を書き込む
- コマンドが成功すると、wrangler.jsoncファイルにD1データベースの識別子が書き込まれる
- ダッシュボード ＞ ストレージとデータベース ＞ D1 SQL データベース ＞ データベース一覧にtodoapiがあることを確認する

schema.sqlを作成する

```sql
DROP TABLE IF EXISTS todos;

CREATE TABLE todos (
    id INTEGER PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT NOT NULL
);

INSERT INTO todos (title, content) VALUES
("タスク1", "タスク1です"),
("タスク2", "タスク2です"),
("タスク3", "タスク3です");
```

ローカル環境にデータベースを作成し、開発＆デバッグする

```bash
npx wrangler d1 execute todoapi --local --file=./schema.sql
npx wrangler d1 execute todoapi --local --command='SELECT * FROM todos'
```

## 4. Honoをインストールする

```bash
npm install hono
```

src/index.tsを全面上書きする

```javascript
import { Hono } from "hono";

const app = new Hono();

app.get("/", (c) => c.json({ message: "Hello Cloudflare Workers!"}));

export default app;
```

## 5. 選択系のAPIを作成する

src/index.ts

```javascript
import { Hono } from "hono";

export interface Env {
    todoapi: D1Database;
}

const app = new Hono<{ Bindings: Env }>().basePath("/api");

// 1件取得
app.get("/todos/:id", async (c) => {
    const id = c.req.param("id");
    try {
        const { results } = await c.env.todoapi.prepare(
            "SELECT * FROM todos WHERE id = ?"
        )
            .bind(id)
            .all();
        return c.json(results);
    } catch (e) {
        return c.json({ err: e }, 500);
    }
});

// 全件取得
app.get("/todos", async (c) => {
    try {
        const { results } = await c.env.todoapi.prepare(
            "SELECT * FROM todos"
        ).all();
        return c.json(results);
    } catch (e) {
        return c.json({ err: e }, 500);
    }
});

export default app;
```

## 6. 更新系のAPIを作成する

src/index.ts

```javascript
// 1件登録
app.post("/todos", async (c) => {
    const { title, content } = await c.req.json();
    try {
        await c.env.todoapi.prepare(
            "INSERT INTO todos (title, content) VALUES (?, ?)"
        ).bind(title, content).run();
        return c.json({ message: "success" }, 201);
    } catch (e) {
        return c.json({ err: e }, 500);
    }
});

// 1件削除
app.delete("/todos/:id", async (c) => {
    const id = c.req.param("id");
    try {
        await c.env.todoapi.prepare(
            "DELETE FROM todos WHERE id = ?"
        )
            .bind(id)
            .run();
        return c.json({ message: "success" }, 200);
    } catch (e) {
        return c.json({ err: e }, 500);
    }
});

// 1件更新
app.put("/todos/:id", async (c) => {
    const id = c.req.param("id");
    const { title, content } = await c.req.json();
    try {
        await c.env.todoapi.prepare(
            "UPDATE todos SET title = ?, content = ? WHERE id = ?"
        ).bind(title, content, id).run();
        return c.json({ message: "success" }, 200);
    } catch (e) {
        return c.json({ err: e }, 500);
    }
});
```

## 7. Cloudflare Workersにデプロイする

```bash
npm run deploy
# => 好きな名前でsubdomainを作成する
# => 成功するとURLが表示される

npx wrangler d1 execute todoapi --remote --file=./schema.sql
```
