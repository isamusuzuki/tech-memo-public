# D1データベースを試す

作成日 2025/09/10、更新日 2025/09/26

## 1. 解説動画を写経する

解説動画 => [【Cloudflare Workers】HonoとCloudflare D1を使って20分でREST APIを作成する](https://www.youtube.com/watch?v=XyjACmtXqj0)

公式ガイド（英語） => [Getting started · Cloudflare D1 docs](https://developers.cloudflare.com/d1/get-started/)

## 2. 新規プロジェクト開始

```bash
npm create cloudflare@latest
# dir ./simple-todo-api
# category Hello World example
# type Worker only
# lang TypeScript
# no git
# no deploy via 'npm run deploy'

cd simple-todo-api
npm run dev #=> Open browser to http://localhost:8787/
```

## 3. データベース作成

```bash
npx wrangler d1 create todoapi
```

- 開発コンテナを使っていると、ブラウザからのOAuthトークンの受け渡しがうまくいかない
- 代わりに、APIトークンを使用する
- ダッシュボード ＞ アカウントの管理 ＞ アカウントAPIトークン ＞ トークンを作成する ＞ D1編集の権限を追加したトークンを作成する
- .envファイルに、`CLOUDFLARE_API_TOKEN=xxx`を書き込む
- ダッシュボード ＞ アカウントホーム ＞ アカウント名の右横にある縦3個ドットをクリック ＞ アカウントIDをコピー
- wrangler.jsoncファイルに、`"account_id": "xxx"`を書き込む

schema.sqlを作成する

```sql
DROP TABLE IF EXISTS todos;

CREATE TABLE todos (
    id INTEGER PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT NOT NULL
);

INSERT INTO todos (title, content) VALUES
("タスク1", "タスク1です"),
("タスク2", "タスク2です"),
("タスク3", "タスク3です");
```

ローカル環境にデータベースを作成し、テストする

```bash
npx wrangler d1 execute todoapi --local --file=./schema.sql
npx wrangler d1 execute todoapi --local --command='SELECT * FROM todos'
```

## 4. Honoをインストールする

```bash
npm install hono
```

src/index.tsを全面上書きする

```javascript
import { Hono } from "hono";

const app = new Hono();

app.get("/", (c) => c.json({ message: "Hello Cloudflare Workers!"}));

export default app;
```

## 5. クエリー系のAPIを作成する

src/index.ts

```javascript
import { Hono } from "hono";

export interface Env {
    todoapi: D1Database;
}

const app = new Hono<{ Bindings: Env }>().basePath("/api");

app.get("/todos/:id", async (c) => {
    const id = c.req.param("id");
    try {
        const { results } = await c.env.todoapi.prepare(
            "SELECT * FROM todos WHERE id = ?"
        )
            .bind(id)
            .all();
        return c.json(results);
    } catch (e) {
        return c.json({ err: e }, 500);
    }
});

export default app;
```

11:25まで
