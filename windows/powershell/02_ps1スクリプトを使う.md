# ps1 スクリプトを使う

作成日 2020/02/04

## 01. コンソール出力が文字化けするときの原因と対処方法

`Write-Output "ハローワールド"` が文字化けするのは、ファイルが `UTF-8（BOMなし）` で保存されているため\
ps1ファイルは、必ず `UTF-8 with BOM` で保存する

## 02. 引数をとる

```bash
param($name)
if($null -eq $name) {
  throw 'You need 1 argument. (name)'
}

# 複数の引数をとる
param($name, $type)
if($null -eq $name -or $null -eq $type) {
  throw 'You need 2 arguments. (name, type)'
}
```

## 03. ダブルクォートをエスケープする

```bash
# バックチックを使う
$msg = "Hello"
Write-Output("`"$msg`"")
# => "Hello"
```

## 04. パスワードを自動生成する

```bash
$length = 6
$password = ''
$seed = @('2','3','4','5','6','7','8','9','a', 'b', 'c',
'd','e','f','g','h','k','m','n','p','q','r','s',
't','u','v','w','x','y','z')
# o（オー）と 0（ゼロ）
# 1（イチ）と l（エル）
# i（アイ）と j（ジェイ）
# 以上の3組は、間違いやすいので外した

for ($i = 0; $i -lt $length; $i++) {
    $password += Get-Random -InputObject $seed
}

Write-Output("password: $($password)")
```

## 05. 暗号化 ZIP ファイルを作成する

```bash
# 7zipのコマンドライン版をインストールする
choco install 7zip.portable -y

# <命令> <圧縮ファイル名> <圧縮したいファイル名>
7z a data.zip tokyo171026.txt

# パスワード付きで圧縮ファイルを作成する
7z a data.zip tokyo171026.txt -pdaikon

# 複数のファイルをひとつの圧縮ファイルに入れられる
7z a data.zip a.txt b.txt -pdaikon
```

## 06. 資格情報オブジェクトを使って作業する

```bash
# パスワードをファイルに保存する
$p = Read-Host "Input a password." -AsSecureString
ConvertFrom-SecureString $p | Set-Content password.txt

# get_savedCrential.ps1というファイルを作成する
param($userName, $path)
if($null -eq $path) {
    Get-Credential $userName
} else {
    $savedSecureString = ConvertTo-SecureString(Get-Content $path)
    New-Object System.Management.Automation.PSCredential $userName　$savedSecureString
}

# 保存したパスワードを読み込んで資格情報オブジェクトを作成する
$cred = .\get_savedCredential.ps1 -userName suzuki -path password.txt

# 資格情報を使ったコマンドを実行する
Enter-PSSession -ComputerName server -Credential $cred
```

## 7. ローカルにある SQL サーバーを操作する

### backupdb.ps1

```bash
# SQLサーバーに接続する
[void][System.Reflection.Assembly]::LoadWithPartialName('Microsoft.SqlServer.SMO')
$sqlserver = New-Object Microsoft.SqlServer.Management.SMO.Server("JIMUKYOKU\SQLEXPRESS")

# バックアップファイルを設定する
$dbname = $sqlserver.Databases.Item("jimukyokudb").Name
$datetime = Get-Date -Format yyyyMMdd_HHmm
$backupfile = "C:\sqlbackup\$($dbname)_$($datetime).back"

# バックアップを実行する
Backup-SqlDatabase -ServerInstance $sqlserver.Name -Database $dbname -BackupFile $backupfile

Write-Output "backup finished"

# ディレクトリを変更する
C:

# 資格情報を取得する
$credential = .\get_savedCredential.ps1 -userName suzuki -path .\password.txt

# 新しいPSドライブを設定する
New-PSDrive -Name Z -PSProvider FileSystem -Root \\公開サーバー\公開フォルダ -Persist -Credential $credential

# バックアップファイルをコピーする
Copy-Item $backupfile Z:\sqlbackup

# PSドライブを削除する
Remove-PSDrive -Name Z

# ローカルのバックアップファイルを削除する
Remove-Item $backupfile

Write-Output "copy finished"
```

### get_sevedCredential.ps1

```bash
param($userName, $path)

if($null -eq $path) {
    Get-Credential $userName
} else {
    $savedSecureString = ConvertTo-SecureString(Get-Content $path)
    New-Object System.Management.Automation.PSCredential $userName　$savedSecureString
}
```
