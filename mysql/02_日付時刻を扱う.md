# 日付時刻を扱う

作成日 2020/02/01、更新日 2020/02/18

## 01. 関数で日付時刻を作成する

```sql
select now();
-- 2020-02-18 08:40:34

select current_date();
-- 2020-02-18
```

### MySQLのタイムゾーンはシステムに依存している

```sql
show variables like '%time_zone%';
-- system_time_zone | UTC    |
-- time_zone        | SYSTEM |
```

Ubuntuの上で動かしているMySQLの場合、\
Ubuntuのタイムゾーンを変更してから、\
MySQLを再起動したら、それだけで変更された

```sql
show variables like '%time_zone%';
-- system_time_zone | JST    |
-- time_zone        | SYSTEM |
```

## 02. 連続した日付の仮想表を使う

### まずは、連番の仮想表をつくる

```sql
SELECT 0 generate_series FROM DUAL WHERE (@num := 1 - 1)*0 UNION ALL
SELECT @num := @num + 1 FROM `information_schema`.COLUMNS LIMIT 25
-- 1から25まで連番が表示される
```

### 連番を利用して、日付の仮想表をつくる

```sql
set @before_day = '2019-11-30';

select date_format(
	date_add(@before_day, interval td.generate_series day), 
    '%Y-%m-%d') d
from
(
	SELECT 0 generate_series FROM DUAL WHERE (@num := 1 - 1)*0 UNION ALL
	SELECT @num := @num + 1 FROM `information_schema`.COLUMNS LIMIT 25
) td;
-- 2019-12-01から2019-12-25までの日付が表示される
```

```sql
set @sid = 'AC73c2158699cce0c068da29afbe9ad4a3';
set @before_day = '2019-11-30';

select t1.d date
, coalesce(t2.c, 0) cdr_count
, coalesce(t3.c, 0) sms_count
from
(
    select
    date_format(
        date_add(@before_day, interval td.generate_series day), 
        '%Y-%m-%d') d
    from
    (
        SELECT 0 generate_series FROM DUAL WHERE (@num:=1-1)*0 UNION ALL
        SELECT @num:=@num+1 FROM `information_schema`.COLUMNS LIMIT 25
    ) td
) t1

left outer join
(
    select DATE_FORMAT(date_created, '%Y-%m-%d') d
    , count(sid) c
    from call_detail_records
    where account_sid = @sid
    group by d
) t2 on t1.d = t2.d

left outer join
(
    select DATE_FORMAT(date_created, '%Y-%m-%d') d
    , count(sid) c
    from sms_messages
    where account_sid = @sid
    group by d
) t3 on t1.d = t3.d
```

