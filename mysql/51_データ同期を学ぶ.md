# MySQL データ同期を学ぶ

作成日 2019/07/05

## 00. MySQL ログファイルの種類

参考記事 => [MySQL における４つのログファイルの設定と確認方法 \| サービス \| プロエンジニア](https://proengineer.internous.co.jp/content/columnfeature/7002)

1. general query log
1. slow query log
1. binary log
1. error log

- スロークエリーログとエラーログは、デフォルトで設定がオンになっている
- ゼネラルクエリーログとバイナリログは、追加の設定が必要

## 01. MySQL レプリケーション

参考記事 1 => [MySQL レプリケーション設定 \-手順・各種ステータスの詳細とトラブルシューティング\- \- Qiita](https://qiita.com/mamy1326/items/a337ed0fa22104b08f3d)

- MySQL の標準機能
- マスター（単一）・スレーブ（単一または複数）構成
- マスターはコミット後、スレーブ対して更新イベントを通知する
- 更新内容（バイナリログ、コミットログ）をスレーブがマスターに取りに行く（I/O スレッド）

参考記事 2 => [MySQL 入門　レプリケーション編 \- Qiita](https://qiita.com/Tocyuki/items/c224cef57493f536a941)

日本語公式マニュアル => [https://dev.mysql.com/doc/refman/5.6/ja/replication.html](https://dev.mysql.com/doc/refman/5.6/ja/replication.html)

> レプリケーションによって、1 つの MySQL データベースサーバー (マスター) のデータを、1 つまたは複数の MySQL データベースサーバー (スレーブ) に複製できます。レプリケーションはデフォルトで非同期であるため、スレーブはマスターから更新を受け取るために永続的に接続されている必要はありません。

日本語公式 FAQ => [https://dev.mysql.com/doc/refman/5.6/ja/faqs-replication.html](https://dev.mysql.com/doc/refman/5.6/ja/faqs-replication.html)

> A.13.3 マスターと比較してスレーブがどれくらい遅れているかを判別するにはどのようにすればよいですか。
>
> SHOW SLAVE STATUS の出力の Seconds_Behind_Master カラムを確認してください。スレーブの SQL スレッドでマスターから読み取ったイベントを実行するときに、このスレッドは実行時の時間をイベントのタイムスタンプに変更します。(これにより、TIMESTAMP が正常にレプリケートされます。)
>
> A.13.5 二方向レプリケーションを設定する場合に注意する問題はありますか。
>
> 現在、MySQL レプリケーションでは、分散 (サーバー間) 更新の原子性を保証するためのマスターおよびスレーブ間のロックプロトコルはサポートされていません。
>
> A.13.10 マスターサーバーがステートメントベースのバイナリロギング形式または行ベースのバイナリロギング形式のどちらを使用しているかを判別するにはどうすればよいですか。
>
> binlog_format システム変数の値を確認します。
> `mysql> SHOW VARIABLES LIKE 'binlog_format';`

## 02. MySQL バイナリログ

参考記事 => [MySQL のバイナリログを活用しリストア＆リカバリで障害時でも DB 完全復旧可能な体制を整える。](https://www.ritolab.com/entry/98)

### ステートメントベースロギング (SBL)と行ベースロギング (RBL)

日本語マニュアル => [https://dev.mysql.com/doc/refman/5.6/ja/replication-sbr-rbr.html](https://dev.mysql.com/doc/refman/5.6/ja/replication-sbr-rbr.html)

- SBL は、ログファイルに書き込まれるデータが少ない。変更があったすべてのステートメントが含まれるが、すべてのステートメントがあるわけではない
- RBL は、すべての変更を複製できるが、ログファイルに書き込まれるデータが増える

### バイナリログに対する素朴な疑問

バイナリログでは、kintone からのデータ更新と、もりもりからのデータ更新の違いがわからない

バイナリログを、 1 秒間隔という短いサイクルで読み解いていけるのか？

### mysqlbinlog コマンド

バイナリログは、mysqlbinlog コマンドで取り扱い可能

日本語マニュアル => [https://dev.mysql.com/doc/refman/5.6/ja/mysqlbinlog.html](https://dev.mysql.com/doc/refman/5.6/ja/mysqlbinlog.html)

[Identifying useful info from MySQL row\-based binary logs](https://www.percona.com/blog/2015/01/20/identifying-useful-information-mysql-row-based-binary-logs/)

mysqlbinlog + awk を使って、バイナリログを解析する

### GTID (Global Transaction ID)

- MySQL 5.6 で追加された機能
- トランザクションをグローバルで一意に識別できる識別子をバイナリログに記録する
- バイナリログのポジションを自動認識してくれる

## 03. Google Cloud SQL for MySQL

コンセプトページ => [https://cloud.google.com/sql/docs/mysql/concepts?hl=ja](https://cloud.google.com/sql/docs/mysql/concepts?hl=ja)

[高可用性構成の概要](https://cloud.google.com/sql/docs/mysql/high-availability?hl=ja)

> HA 構成は、クラスタとも呼ばれ、データの冗長性を確保します。この構成は、プライマリインスタンスとフェイルオーバーレプリカからなります。準同期レプリケーションを使用すると、プライマリインスタンスのすべての変更が、フェイルオーバーレプリカにコピーされます。

準同期レプリケーションの英語ページ　=> [https://dev.mysql.com/doc/refman/5.7/en/replication-semisync.html](https://dev.mysql.com/doc/refman/5.7/en/replication-semisync.html)

（自分訳）非同期レプリケーションでは、マスターはバイナリログにイベントを書き、スレーブは自分がレディになったときににそれを要求します。そこには、すべてのスレーブにすべてのイベントが届いたという保証はありません。

[レプリケーションのオプション](https://cloud.google.com/sql/docs/mysql/replication/?hl=ja)

> Cloud SQL は、マスター インスタンスを 1 つ以上のリードレプリカに複製する機能を備えています。リードレプリカはマスターのコピーで、マスター インスタンスへの変更がほぼリアルタイムで反映されます。

[レプリケーションを構成するための要件とヒント](https://cloud.google.com/sql/docs/mysql/replication/tips?hl=ja)

> リードレプリカをサポートするには、マスター インスタンスのバイナリログを有効にする必要があります。

## 04. データ同期はどうやって実現しているか

MySQL は、2 つの DB 間の同期という機能は持っていない。あるのはバイナリログによるレプリケーションだけ。

### MySQL 以外のデータベースではどうか

[異なるデータベース間のデータ同期が出来るわけ \(その 2\) \| Insight Technology, Inc\.](https://www.insight-tec.com/blog/technical/20180312_attunity2)

> レプリケーションソフトウェアは連携元(ソース)データベースのトランザクションログを解析して変更 SQL を抽出し、その SQL を連携先(ターゲット)データベースで実行するということを繰り返しています。これにより、ニアリアルタイムでのデータ同期を実現しています。

- Oracle はデータベースへの変更を記録するファイルを、トランザクションログと呼んでいる
- トランザクションログから、INSERT 文、UPDATE 文、DELETE 文を抜き出して、別の DB でも同じように実行させる
- データ同期と呼んではいるが、レプリケーションでしかない
